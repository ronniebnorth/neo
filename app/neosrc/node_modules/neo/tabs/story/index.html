<ph-components>
  <template name="story-editor">
    <style>
      :host {
        display: block;

        flex: 1 1 50em;

        background-color: #fff;

        min-width: 50em;
        height: 100%;

        text-align: left;

        display: inline-block;

        margin: 1em 1em 3em 1em;
      }
    </style>
    <content></content>
    <script>
      class StoryEditor extends PhElement {
        constructor() {
          super();
        }

        connectedCallback() {
          super.connectedCallback();

          this.setAttribute('tabindex', '0');

          $(this).on('keydown keyup keypress', this._handleKeyEvent);
          $(this).on('beforeinput input', this._handleInputEvent);

          $(this).on('focus', e => $(this).find('nui-cursor').focus());
        }

        get story() {
          return this._story;
        }

        set story(newStory) {
          this._story = newStory;
          $(this).html(this.story.story.body);
        }

        get doc() {
          return $(this).find('*')[0];
        }

        save() {
          if (!this.story) {
            return;
          }

          this.story.story.body = $(this).html();
          this.story.write();
        }

        _handleKeyEvent(e) {
          var pke = keyboard.processKeyEvent(e.originalEvent);

          if (pke.type == 'keypress' && pke.isData) {
            this.doc.insert(pke.data);
          }

          if (pke.isCommand) {
            if ('_Command' + pke.command in this) {
              if (this['_Command' + pke.command](pke)) {
                e.preventDefault();

                return false;
              }
            }
          }
        }

        _handleInputEvent(e) {
          console.log('editor handling input event', e);
        }

        _CommandBackspace(pke) {
          if (pke.originalEvent.type != 'keydown' || pke.hasModifier) {
            return false;
          }

          this.doc.backspace();

          return true;
        }

        _CommandArrowLeft(pke) {
          if (pke.originalEvent.type != 'keydown') {
            return false;
          }

          this.doc.cursorLeft();

          return true;
        }

        _CommandArrowRight(pke) {
          if (pke.originalEvent.type != 'keydown') {
            return false;
          }

          this.doc.cursorRight();

          return true;
        }

        _CommandEnter(pke) {
          if (pke.originalEvent.type != 'keydown') {
            return false;
          }

          this.doc.lineBreak();

          return true;
        }
      }
    </script>
  </template>
</ph-components>
